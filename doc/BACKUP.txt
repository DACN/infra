======
Backup
======

This document describes how we do backup of our machines and services.

Summary: we are storing to S3 (via EBS from Amazon EC2 hosts).

  * We take rsync snapshots of the machine to, say, /mnt/backup /backup using
    browser:cron/backup
  * On non-EC2 servers these results are rsynced over to an EC2 instance
  * On EC2 instances /backup is an EBS volume
  * These EBS volumes are regularly snapshotted to S3 (TODO)


Details
=======

1. Allocate space/device for the backup
---------------------------------------

For EC2 we allocate an EBS volume for the back to the given amazon instance.
You can do this automatically using the aws scripts::

  # cd aws
  # ./manage.py -h to get details
  # you can find out instance-ids by doing ./manage.py print_info
  ./manage.py create_ebs {instance-id}

  # you now need to format the extension
  # use aws/fabfile.py for this
  cd aws


2. Setup backup (scripts and config)
------------------------------------

We install scripts and config automatically via symlinks from this sysadmin
repo. This is automated by fabfile commands::

    cd bin
    # to install/update sysadmin repo see
    # fab sysadmin_repo_* commands
    fab backup_setup --host XX.okfn.org --user YYY

This installs the following material (NB: probably best to read the code for
the authorative statement on this -- docs go out of date faster than code!)::

    /etc/backup/backuprc -- set three basic params
    /etc/backup/backup_exclude
    /etc/backup/backup_include
    # classic *.d/ file for extra backup scripts to be
    # run *prior* to backup of files to new backup location
    /etc/backup/backup.d/

Actual backup script is:

    /etc/cron/backuprotatingsnapshot
   

Possibilities for the future
============================

  * Bacula: very mature
  * Duplicity: python and simple

Dicusssion:

  * http://stackoverflow.com/questions/15208/whats-the-best-linux-backup-solution

