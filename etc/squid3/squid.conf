##################################################################
#
# IMPORTANT. PLEASE READ.
# 
# IF YOU DON'T HAVE THE TIME TO READ, THEN DO NOT EDIT THIS FILE
#
##################################################################
#
# This squid.conf is used by both our cache servers:
# 
#  * s006/eu6 = cache-euw1.okserver.org  in EC2 (DC "eu-west-1")
#  * s050     = cache-sov.okserver.org   at Fry (DC "SOV")
#
#
# So please help to keep them in sync:
# 
#  * Before editing this file here, make sure there are no 
#    un-pushed changes at the other squid server.
#
#  * Before editing this file here, do "hg pull -u"
#
#  * After editing this file here, do not forget to commit and push.
#
#
# Thank you. For more information, please consult 
#
#    http://trac.okfn.org/wiki/CacheService
#
#
# /nils.
#
##################################################################




http_port 80 accel defaultsite=ckan.net vhost


##################################################################
# cache_peer definitions back in here
cache_peer 127.0.0.1 parent 8080 0 no-query originserver name=redirector
cache_peer 127.0.0.1 parent 8081 0 no-query originserver name=downformaint

cache_peer s009-int.okserver.org parent 80 0 no-query originserver name=s009
cache_peer s013-int.okserver.org parent 80 0 no-query originserver name=s013
cache_peer s017-int.okserver.org parent 80 0 no-query originserver name=s017
cache_peer s039.okserver.org     parent 80 0 no-query originserver name=s039
cache_peer s049.okserver.org     parent 80 0 no-query originserver name=s049
cache_peer s053.okserver.org     parent 80 0 no-query originserver name=s053
cache_peer s055.okserver.org     parent 80 0 no-query originserver name=s055 login=PASS
cache_peer s057.okserver.org     parent 80 0 no-query originserver name=s057 login=PASS
cache_peer s063.okserver.org     parent 80 0 no-query originserver name=s063 login=PASS

cache_peer fragdenstaat.de       parent 80 0 no-query originserver name=de01 login=PASS
cache_peer dh1.okserver.org      parent 80 0 no-query originserver name=dh1
cache_peer dh4.okserver.org      parent 80 0 no-query originserver name=dh4


##################################################################
acl redirector_sites dstdomain opendatachallenge.org
acl redirector_sites dstdomain coins.wheredoesmymoneygo.org
acl redirector_sites dstdomain ask.wheredoesmymoneygo.org 
acl redirector_sites dstdomain opendatamanual.org
acl redirector_sites dstdomain www.opendatamanual.org
acl redirector_sites dstdomain opendatasearch.org
acl redirector_sites dstdomain www.opendatasearch.org
acl redirector_sites dstdomain trac.openspending.org
acl redirector_sites dstdomain wiki.ckan.net
acl redirector_sites dstdomain ckan.net
acl redirector_sites dstdomain www.ckan.net
acl redirector_sites dstdomain iati.ckan.net
acl redirector_sites dstdomain openknowledgefoundation.org 
acl redirector_sites dstdomain www.openknowledgefoundation.org 
acl redirector_sites dstdomain ckanhosted.com
acl redirector_sites dstdomain www.ckanhosted.com
acl redirector_sites dstdomain dataprotocols.org
acl redirector_sites dstdomain bibliographica.org
acl redirector_sites dstdomain www.bibliographica.org
acl redirector_sites dstdomain bnb.bibliographica.org
acl redirector_sites dstdomain m.okfn.org
acl redirector_sites dstdomain nederland.ckan.net
acl redirector_sites dstdomain irc.okfn.org
acl redirector_sites dstdomain ca.ckan.net
acl redirector_sites dstdomain si.ckan.net
acl redirector_sites dstdomain semantic.ckan.net

acl downformaint_sites dstdomain notice.okfn.org
acl downformaint_sites dstdomain notice.ckan.org
# non-migrated ex-eu3 sites, see http://trac.okfn.org/ticket/926
acl downformaint_sites dstdomain be.ckan.net
acl downformaint_sites dstdomain bg.ckan.net
acl downformaint_sites dstdomain fi.ckan.net
acl downformaint_sites dstdomain el.ckan.net
acl downformaint_sites dstdomain gr.ckan.net
acl downformaint_sites dstdomain hu.ckan.net
acl downformaint_sites dstdomain lt.ckan.net
acl downformaint_sites dstdomain nz.ckan.net
acl downformaint_sites dstdomain pl.ckan.net
acl downformaint_sites dstdomain katalogdanych.centrumcyfrowe.pl
acl downformaint_sites dstdomain sl.ckan.net
acl downformaint_sites dstdomain southampton.ckan.net
acl downformaint_sites dstdomain dfid.wheredoesmymoneygo.org

# s009/eu9 
acl s009_sites dstdomain opencorrespondence.org
acl s009_sites dstdomain www.opencorrespondence.org
acl s009_sites dstdomain openshakespeare.org
acl s009_sites dstdomain www.openshakespeare.org

# s013/eu13: wiki farm
acl s013_sites dstdomain wiki.ckan.org
acl s013_sites dstdomain wiki.okfn.org
acl s013_sites dstdomain wiki.okfn.de
acl s013_sites dstdomain wiki.openspending.org
acl s013_sites dstdomain board.okfn.org
acl s013_sites dstdomain methods.okfn.org
acl s013_sites dstdomain oldwiki.okfn.org
acl s013_sites dstdomain wiki.offenerhaushalt.de
acl s013_sites dstdomain wiki.openliterature.net

# s017/eu17
acl s017_sites dstdomain isitopendata.org
acl s017_sites dstdomain www.isitopendata.org

# s039/us9: trac farm
acl s039_sites dstdomain trac.ckan.org

# s049: IATI
acl s049_sites dstdomain wordpress.iatiregistry.org

# s053: blog farm
acl s053_sites dstdomain blog.okfn.org
acl s053_sites dstdomain okfn.org
acl s053_sites dstdomain www.okfn.org
acl s053_sites dstdomain okfn.de
acl s053_sites dstdomain www.okfn.de
acl s053_sites dstdomain openbiblio.net
acl s053_sites dstdomain www.openbiblio.net
acl s053_sites dstdomain openarthistory.org
acl s053_sites dstdomain www.openarthistory.org
acl s053_sites dstdomain ckan.org
acl s053_sites dstdomain www.ckan.org
acl s053_sites dstdomain blog.ckan.org
acl s053_sites dstdomain bigclean.org
acl s053_sites dstdomain www.bigclean.org
acl s053_sites dstdomain opengovernmentdata.org 
acl s053_sites dstdomain www.opengovernmentdata.org
acl s053_sites dstdomain blog.openspending.org
acl s053_sites dstdomain openeconomics.net
acl s053_sites dstdomain www.openeconomics.net
acl s053_sites dstdomain planet.okfn.org
acl s053_sites dstdomain okcon.org
acl s053_sites dstdomain www.okcon.org
acl s053_sites dstdomain publicdomainreview.org
acl s053_sites dstdomain www.publicdomainreview.org
acl s053_sites dstdomain opendatacommons.org
acl s053_sites dstdomain www.opendatacommons.org
acl s053_sites dstdomain ogdcamp.org
acl s053_sites dstdomain www.ogdcamp.org
acl s053_sites dstdomain openliterature.net
acl s053_sites dstdomain www.openliterature.net
acl s053_sites dstdomain openaiddata.de
acl s053_sites dstdomain www.openaiddata.de
acl s053_sites dstdomain openglam.org
acl s053_sites dstdomain www.openglam.org
acl s053_sites dstdomain opendefinition.org
acl s053_sites dstdomain www.opendefinition.org
acl s053_sites dstdomain wheredoesmymoneygo.org
acl s053_sites dstdomain www.wheredoesmymoneygo.org
acl s053_sites dstdomain pantonprinciples.org
acl s053_sites dstdomain www.pantonprinciples.org
acl s053_sites dstdomain bibserver.org
acl s053_sites dstdomain www.bibserver.org
acl s053_sites dstdomain blog.thedatahub.org
acl s053_sites dstdomain schoolofdata.org
acl s053_sites dstdomain www.schoolofdata.org

# s055: thedatahub.org
acl s055_sites dstdomain s055.okserver.org
acl s055_sites dstdomain thedatahub.org
acl s055_sites dstdomain www.thedatahub.org
acl s055_sites dstdomain datahub.io
acl s055_sites dstdomain www.datahub.io

# s057: ckan farm (http://trac.okfn.org/ticket/933)
acl s057_sites dstdomain s057.okserver.org
acl s057_sites dstdomain cz.ckan.net
acl s057_sites dstdomain br.ckan.net
acl s057_sites dstdomain ie.ckan.net
acl s057_sites dstdomain no.ckan.net
acl s057_sites dstdomain it.ckan.net
acl s057_sites dstdomain colorado.ckan.net
acl s057_sites dstdomain publicdata.eu
acl s057_sites dstdomain www.publicdata.eu

# s063: miscellaneous python webapps
acl s063_sites dstdomain ideas.okfn.org
acl s063_sites dstdomain getthedata.org
acl s063_sites dstdomain www.getthedata.org
acl s063_sites dstdomain weavinghistory.org

# de01/fragdenstaat.de
acl de01_sites dstdomain de.ckan.net
acl de01_sites dstdomain ckan.de
acl de01_sites dstdomain www.ckan.de
acl de01_sites dstdomain offenedaten.de
acl de01_sites dstdomain www.offenedaten.de

# dh1/us2   (http://trac.okfn.org/ticket/1096)
acl dh1_sites  dstdomain dh1.okserver.org

# dh4/us2-4 (http://trac.okfn.org/ticket/655)
acl dh4_sites  dstdomain blog.openshakespeare.org


##################################################################
acl admin src 127.0.0.1
acl admin src 46.51.189.76 # eu6 public address
acl admin src 10.227.38.29 # s009
acl admin src 174.136.109.162 # styx.org
acl admin src 193.34.146.142 # s050
acl admin src 193.34.146.141 # s053
acl admindns srcdomain .whiteink.com 
acl PURGE method PURGE
http_access allow PURGE admin
http_access allow PURGE admindns
http_access deny PURGE


##################################################################
http_access allow redirector_sites
http_access allow downformaint_sites
http_access allow s009_sites
http_access allow s013_sites
http_access allow s017_sites
http_access allow s039_sites
http_access allow s049_sites
http_access allow s053_sites
http_access allow s055_sites
http_access allow s057_sites
http_access allow s063_sites
http_access allow de01_sites
http_access allow dh1_sites
http_access allow dh4_sites


##################################################################
cache_peer_access redirector allow redirector_sites
cache_peer_access redirector deny all
cache_peer_access downformaint allow downformaint_sites
cache_peer_access downformaint deny all
cache_peer_access s009 allow s009_sites
cache_peer_access s009 deny all
cache_peer_access s013 allow s013_sites
cache_peer_access s013 deny all
cache_peer_access s017 allow s017_sites
cache_peer_access s017 deny all
cache_peer_access s039 allow s039_sites
cache_peer_access s039 deny all
cache_peer_access s049 allow s049_sites
cache_peer_access s049 deny all
cache_peer_access s053 allow s053_sites
cache_peer_access s053 deny all
cache_peer_access s055 allow s055_sites
cache_peer_access s055 deny all
cache_peer_access s057 allow s057_sites
cache_peer_access s057 deny all
cache_peer_access s063 allow s063_sites
cache_peer_access s063 deny all

cache_peer_access de01 allow de01_sites
cache_peer_access de01 deny all
cache_peer_access dh1  allow dh1_sites
cache_peer_access dh1  deny all
cache_peer_access dh4  allow dh4_sites
cache_peer_access dh4  deny all


##################################################################
negative_ttl 0 # do not cache negative hits

cache_mem 1024 MB
cache_dir ufs /var/spool/squid3 20000 255 255

access_log /var/log/squid3/access.log squid


##################################################################
# NB: the format for refresh_pattern is:
#   refresh_pattern [-i] regex min percent max [options]
#
# min and max are measured in *minutes*, not *seconds*

refresh_pattern ./*/revision/list/            30 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims
refresh_pattern http://planet.okfn.org/feed.* 60 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims
refresh_pattern http://planet.okfn.org/       60 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims

# cache front page
refresh_pattern http://okfn.org/$ 15 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims

# blog caching
refresh_pattern http://blog.okfn.org/page.*        15 0% 720 ignore-no-cache refresh-ims
refresh_pattern http://blog.okfn.org/[0-9][0-9].*  15 0% 720 ignore-no-cache refresh-ims
refresh_pattern http://blog.okfn.org/feed.*        15 0% 720 ignore-no-cache refresh-ims
refresh_pattern http://blog.okfn.org/category.*    15 0% 720 ignore-no-cache refresh-ims
refresh_pattern http://blog.okfn.org/wp-content/.* 15 0% 720 ignore-no-cache refresh-ims
refresh_pattern http://blog.okfn.org/$             15 0% 720 ignore-no-cache refresh-ims

refresh_pattern http://publicdata.eu/$ 15 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims

refresh_pattern http://publicdomainreview.org/$ 15 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims

refresh_pattern http://ogdcamp.org/$ 15 0% 720 override-expire override-lastmod ignore-no-cache ignore-no-store ignore-reload ignore-private reload-into-ims

