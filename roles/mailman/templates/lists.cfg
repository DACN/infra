server {
	listen 80;
        listen [::]:80 ipv6only=on;

        server_name {% for domain in listserv_domains %} {{ domain }} {% endfor %};
        root /usr/lib;

	set_real_ip_from   204.93.240.0/24;
	set_real_ip_from   204.93.177.0/24;
	set_real_ip_from   199.27.128.0/21;
	set_real_ip_from   173.245.48.0/20;
	set_real_ip_from   103.21.244.0/22;
	set_real_ip_from   103.22.200.0/22;
	set_real_ip_from   103.31.4.0/22;
	set_real_ip_from   141.101.64.0/18;
	set_real_ip_from   108.162.192.0/18;
	set_real_ip_from   190.93.240.0/20;
	set_real_ip_from   188.114.96.0/20;   
	set_real_ip_from   197.234.240.0/22;
	set_real_ip_from   198.41.128.0/17;
	set_real_ip_from   162.158.0.0/15;
	set_real_ip_from   2400:cb00::/32;
	set_real_ip_from   2606:4700::/32;
	set_real_ip_from   2803:f800::/32;
	set_real_ip_from   2405:b500::/32;
	set_real_ip_from   2405:8100::/32;
	real_ip_header     CF-Connecting-IP;

        location = / {
                rewrite ^ /mailman/listinfo;
        }
 
        location / {
                rewrite ^ /mailman$uri?$args;
        }
 
        location = /mailman/ {
                rewrite ^ /mailman/listinfo;
        }
 
        location ~ ^/mailman/([^/]+)(/?.*)$ {
                gzip off;
                root		/usr/lib/cgi-bin/mailman;
                fastcgi_pass	unix:/var/run/fcgiwrap.socket;
                fastcgi_param   QUERY_STRING            $query_string;
                fastcgi_param   REQUEST_METHOD          $request_method;
                fastcgi_param   CONTENT_TYPE            $content_type;
                fastcgi_param   CONTENT_LENGTH          $content_length;

                fastcgi_param   REQUEST_URI             $request_uri;
                fastcgi_param   DOCUMENT_URI            $document_uri;
                fastcgi_param   DOCUMENT_ROOT           $document_root;
                fastcgi_param   SERVER_PROTOCOL         $server_protocol;

                fastcgi_param   SCRIPT_NAME             $1;
                fastcgi_param   SCRIPT_FILENAME         $document_root/$1;
                fastcgi_param   PATH_INFO               $2;

                fastcgi_param   GATEWAY_INTERFACE       CGI/1.1;
                fastcgi_param   SERVER_SOFTWARE         nginx/$nginx_version;

                fastcgi_param   REMOTE_ADDR             $remote_addr;
                fastcgi_param   REMOTE_PORT             $remote_port;
                fastcgi_param   SERVER_ADDR             $server_addr;
                fastcgi_param   SERVER_PORT             $server_port;
                fastcgi_param   SERVER_NAME             $server_name;

                fastcgi_param   HTTPS                   $https;
        }
 
        location /images/mailman {
                alias /var/lib/mailman/icons;
        }
 
        location /pipermail {
                alias /var/lib/mailman/archives/public;
                autoindex on;
        }
}
